<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Hexo</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Quansui&#039;s Blog"><meta name="msapplication-TileImage" content="/my_img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Quansui&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="https://zjsygqs398.github.io/blog"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://zjsygqs398.github.io/blog/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://zjsygqs398.github.io/blog/img/og_image.png"><meta property="fb:app_id"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zjsygqs398.github.io/blog"},"headline":"Hexo","image":["https://zjsygqs398.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"https://zjsygqs398.github.io/my_img/logo.svg"}},"description":""}</script><link rel="icon" href="/blog/my_img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/"><img src="/blog/my_img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a><a class="navbar-item" target="_blank" rel="noopener" href="https://github.com/zjsygqs398">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zjsygqs398"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-16T00:08:50.000Z" title="6/16/2024, 10:08:50 AM">2024-06-16</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T01:27:25.201Z" title="6/20/2024, 11:27:25 AM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/USYD-Lecture/">USYD - Lecture</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/06/16/DATA%205207/">USYD - DATA 5207</a></p><div class="content"><h1 id="DATA-5207"><a href="#DATA-5207" class="headerlink" title="DATA 5207"></a>DATA 5207</h1><h1 id="Lecture-2"><a href="#Lecture-2" class="headerlink" title="Lecture 2"></a>Lecture 2</h1><p>presenting data to non-expert (visualization)</p>
<p>less technical knowledge</p>
<p>making data engage</p>
<p>convey the pattern</p>
<p>Data Graphics</p>
<p>3 consideration</p>
<p>what information want to communicate</p>
<p>who is the target audience</p>
<p>why design this feature relevant</p>
<h1 id="Lecture-3"><a href="#Lecture-3" class="headerlink" title="Lecture 3"></a>Lecture 3</h1><p>confounding factors: earning by height, may it occur by gender</p>
<p>select the topic this weekend</p>
<p>RMD template</p>
<h1 id="Lecture-4"><a href="#Lecture-4" class="headerlink" title="Lecture 4"></a>Lecture 4</h1><p>better R square, better job the model does. This means the better-fitting in model</p>
<p>maximize the variables in the model</p>
<p>not only use the technic thing to fit the data but adding the theoretical thing to increase the use in practice</p>
<p>observational data can not make the causal inference (confounding factor included)</p>
<p>model error</p>
<p>random errors (precision limitation - sample number)</p>
<p>systematic error (error in research design - non-sampling error)</p>
<p>difference between observed and actual</p>
<p>response, instrument, interviewer</p>
<p>sample design error</p>
<p>selection, frame</p>
<p>explore dataset  graphs</p>
<p>variables</p>
<p>model choice</p>
<p>correlation plot all variables</p>
<p>variable selection methods  -  stepwise, lasso, or </p>
<h1 id="Lecture-5"><a href="#Lecture-5" class="headerlink" title="Lecture 5"></a>Lecture 5</h1><p>limitation of the LR is assuming the relationship is linear</p>
<p>logits?</p>
<p>ordinal logistic regression (agree, very agree, etc)</p>
<p>For the material in lab 5, the last image can be repainted as for each year, plot the importance of each variable (independent factor) into a single panel.</p>
<h1 id="Lecture-6"><a href="#Lecture-6" class="headerlink" title="Lecture 6"></a>Lecture 6</h1><p>fuzzyjoin is a function that similar operation in SQL</p>
<h2 id="Research-Plan-Format"><a href="#Research-Plan-Format" class="headerlink" title="Research Plan Format"></a>Research Plan Format</h2><h2 id="Format"><a href="#Format" class="headerlink" title="Format"></a>Format</h2><p>Hide the R chunks, the template has the code to hide</p>
<p><strong>key feature should be identified</strong></p>
<p><strong>why use the LR</strong></p>
<h2 id="Literature"><a href="#Literature" class="headerlink" title="Literature"></a>Literature</h2><p>theory from Literature</p>
<p>hypothesis is for testing? is that the previous section provided</p>
<p>literature: tells you, communicate the hypothesis you provide</p>
<p>inform the things you need to do</p>
<p>underpin the thing you want to explain</p>
<p>may error in the literature section, falsify the idea</p>
<h2 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h2><p>api missing</p>
<p>operation</p>
<h2 id="Limitation"><a href="#Limitation" class="headerlink" title="Limitation"></a>Limitation</h2><p>can be deleted</p>
<h1 id="Lecture-7-Quiz-week"><a href="#Lecture-7-Quiz-week" class="headerlink" title="Lecture 7 Quiz week"></a>Lecture 7 Quiz week</h1><p>data can from </p>
<p>consumer data</p>
<p>social media</p>
<p>AB testing (to decide the better version in different versions)</p>
<p>for instance, the color, and size of the button may sent to users, and the amount they click to decide the better version</p>
<p>census</p>
<p>individuals include surveys</p>
<p>web scraping</p>
<h1 id="Lecture-8"><a href="#Lecture-8" class="headerlink" title="Lecture 8"></a>Lecture 8</h1><p>survey</p>
<p>system error - no random</p>
<p>may younger people be more likely to respond to the phone (phone survey) - nonresponse bias</p>
<p>The census is not like the survey, due to its not doing the data sample, according to the entire residents in the country</p>
<p>random error refers to sampling</p>
<h1 id="Assignment-1"><a href="#Assignment-1" class="headerlink" title="Assignment-1"></a>Assignment-1</h1><ol>
<li>Economic: Q288, 50 (income)<ol>
<li>1</li>
</ol>
</li>
<li>Occupation: Q281, 282, 283</li>
<li>Education: Q275<ol>
<li><a target="_blank" rel="noopener" href="https://d1wqtxts1xzle7.cloudfront.net/49101438/18.01.053.20160304-libre.pdf?1474797472=&response-content-disposition=inline;+filename=Effect_of_Education_on_Quality_of_Life_a.pdf&Expires=1713509378&Signature=bTvJ~0cklHa83ixDEhUTW02gYB4KW0iex7Mx6etlJqBNha-f0l-gvirWcVjlpbtaXdn5SsFoSsWtjeay-18z5De6i3e2wRtZvtx5cuzyJe2RLJHKYPPXrkiEORhb9c35JK~-WjFa7T8c8OIQj5RxD11Gj3W7wCsC3jJw~VOewTDYwkVBKXC1-7BjpWcbOSrkZnazJwulzVzLIERo0l6iO51LIqFi6wY8TSiTTdFGhiHctf9bu2Y7IapgVAwDLKXbpYTdXd3c4nVMPqQry~YQ5iOjKVEmcCdMQwn0HUGe837Dn38-7ttCIbNASUOgpjEGQEjmNlznMsOW9jG~X9VHjw__&Key-Pair-Id=APKAJLOHF5GGSLRBV4ZA">https://d1wqtxts1xzle7.cloudfront.net/49101438/18.01.053.20160304-libre.pdf?1474797472=&response-content-disposition=inline%3B+filename%3DEffect_of_Education_on_Quality_of_Life_a.pdf&amp;Expires&#x3D;1713509378&amp;Signature&#x3D;bTvJ<del>0cklHa83ixDEhUTW02gYB4KW0iex7Mx6etlJqBNha-f0l-gvirWcVjlpbtaXdn5SsFoSsWtjeay-18z5De6i3e2wRtZvtx5cuzyJe2RLJHKYPPXrkiEORhb9c35JK</del>-WjFa7T8c8OIQj5RxD11Gj3W7wCsC3jJw<del>VOewTDYwkVBKXC1-7BjpWcbOSrkZnazJwulzVzLIERo0l6iO51LIqFi6wY8TSiTTdFGhiHctf9bu2Y7IapgVAwDLKXbpYTdXd3c4nVMPqQry</del>YQ5iOjKVEmcCdMQwn0HUGe837Dn38-7ttCIbNASUOgpjEGQEjmNlznMsOW9jG~X9VHjw__&amp;Key-Pair-Id&#x3D;APKAJLOHF5GGSLRBV4ZA</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sciencedirect.com/science/article/pii/S2214804314001153?via=ihub">https://www.sciencedirect.com/science/article/pii/S2214804314001153?via%3Dihub</a></li>
</ol>
</li>
<li>Societal Wellbeing: Q47 (health)</li>
<li>Security: Q131-138, 52</li>
<li>Social capital, trust: Q57-61<ol>
<li><a target="_blank" rel="noopener" href="https://link.springer.com/article/10.1007/s00148-007-0146-7">https://link.springer.com/article/10.1007/s00148-007-0146-7</a> (neighbourhood only)</li>
</ol>
</li>
</ol>
<p>PCA to combine the multiple variables into one feature</p>
<h1 id="Lecture-10"><a href="#Lecture-10" class="headerlink" title="Lecture 10"></a>Lecture 10</h1><p>cable library in R</p>
<h1 id="Lecture-11-Causality"><a href="#Lecture-11-Causality" class="headerlink" title="Lecture 11 - Causality"></a>Lecture 11 - Causality</h1><h1 id="Lecture-12-Journalism"><a href="#Lecture-12-Journalism" class="headerlink" title="Lecture 12 - Journalism"></a>Lecture 12 - Journalism</h1><p>datasplash platform</p>
<h1 id="Final-Project"><a href="#Final-Project" class="headerlink" title="Final Project"></a>Final Project</h1><p>the plots and tables can be included in the report</p>
<p>using the table to regression result (kable) function</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-15T02:10:42.000Z" title="6/15/2024, 12:10:42 PM">2024-06-15</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T03:50:14.683Z" title="6/20/2024, 1:50:14 PM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/USYD-Lecture/">USYD - Lecture</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/06/15/INFO%205992/">USYD - INFO 5992</a></p><div class="content"><h1 id="INFO-5992"><a href="#INFO-5992" class="headerlink" title="INFO 5992"></a>INFO 5992</h1><h1 id="Lecture-1"><a href="#Lecture-1" class="headerlink" title="Lecture 1"></a>Lecture 1</h1><p>3 advantages and disadvantages of 5G wireless connections over 4G.</p>
<ol>
<li><p>More capacity for device connection in the meantime</p>
</li>
<li><p>The higher transmission speed compared to the 4G </p>
</li>
<li><p>The performance of latency shows the advantage</p>
</li>
<li><p>The price of 5G IoT module almost doubled that 4G’s, showing more economic challenge, although showing the benefits on other areas.</p>
</li>
<li><p>The coverage of 5G is weaker than 4G. Meanwhile, much time is still needed to establish an extensive area.</p>
</li>
<li><p>Compatibility may become the upcoming problem in the future. Due to the out-of-date devices may not support the new standard(5G technology).</p>
</li>
</ol>
<p>Q1: Yes. </p>
<ol>
<li>The benefits(speed, network capacity and lower latency etc.) of 5G are highly suitable for lots of organizations, especially for IT-based organizations. </li>
<li>The development of 5G is unstoppable, the cost, coverage and other weaknesses will be solved in the near future. Therefore, end users, organizations and governments will embrace the network evolution (i.e. 5G).</li>
</ol>
<p>Q2: The price will be lower.</p>
<ol>
<li>The cost of 5G network will be reduced, because of the more mature infrastructure and technology, which will be represented in the market price.</li>
<li>The quantity of 5G users will increase gradually, which means that each 5G station cost will be separate for each user. It also will reduce the cost of 5G network use.</li>
</ol>
<p>Q3: Yes.</p>
<ol>
<li>The 5G breaks many physical limitations. For instance, time latency. In the practice of clinics, one of the biggest limitations of remote operation is a delay in the network. The on-time network(5G) can lower the limitation and enlarge the feasibility.</li>
<li>Also, the high speed of 5G can realize the large-capacity meeting, its all owed to the 5G.</li>
</ol>
<p>Q4: No.</p>
<p>In my point of view, the network 5G is faster than 4G, not fundamentally changing the way of the network, but the development of the network.</p>
<h1 id="Lecture-2"><a href="#Lecture-2" class="headerlink" title="Lecture 2"></a>Lecture 2</h1><ol>
<li>Diffusion of innovation<ol>
<li>Innovation development process</li>
</ol>
</li>
<li>Technology adoption lifecycle model</li>
<li>Dominate Design</li>
</ol>
<h1 id="Lecture-3"><a href="#Lecture-3" class="headerlink" title="Lecture 3"></a>Lecture 3</h1><ol>
<li>Disruptive innovation</li>
<li>Innovator’s dilemma</li>
</ol>
<h1 id="Lecture-4"><a href="#Lecture-4" class="headerlink" title="Lecture 4"></a>Lecture 4</h1><p>API business model</p>
<p>API as product</p>
<p>API promoting means making the main business more popular</p>
<p>API enhancing means making the functionality better</p>
<p>May pro but not en, but it can not be en no pro</p>
<h1 id="Lecture-5"><a href="#Lecture-5" class="headerlink" title="Lecture 5"></a>Lecture 5</h1><p>Types of Crowdsourcing P14</p>
<p><img src="https://zjsygqs398.github.io/blog/post_img/INFO%205992/Untitled.png" alt="Untitled"></p>
<ol>
<li>put information and data to the platform</li>
<li>can compare with others’ solutions (10% better etc.)</li>
<li>creative things</li>
<li>basic level of human intelligence</li>
</ol>
<h1 id="Lecture-6"><a href="#Lecture-6" class="headerlink" title="Lecture 6"></a>Lecture 6</h1><p>user innovation: the innovations from the user or customer (company, B2B), due to the unfulfilled requirement.</p>
<h1 id="Lecture-7"><a href="#Lecture-7" class="headerlink" title="Lecture 7"></a>Lecture 7</h1><p>customer pivoting</p>
<p>solve the problem of the certain segment customers, and solve another problem of the same people</p>
<p>business pivoting</p>
<p>solve the different problems </p>
<h1 id="Lecture-8"><a href="#Lecture-8" class="headerlink" title="Lecture 8"></a>Lecture 8</h1><p>value proposition</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-21T21:06:08.000Z" title="12/22/2023, 8:06:08 AM">2023-12-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T01:34:26.035Z" title="6/20/2024, 11:34:26 AM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Pytorch-Introduction/">Pytorch Introduction</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/22/Tutorial%205/">Pytorch Tutorial 5</a></p><div class="content"><p>The reason use the NN is inner kernel of logistic regression is still linear, to avoid the linear relationship, the NN can use activation function, for instance ReLU.</p>
<p>In this case, we use ReLu as our activation function to predict the image, and it can be found that the accuracy is far better than LR, shows more abilities.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path, mkdir</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> torchvision.datasets <span class="keyword">import</span> MNIST</span><br><span class="line"><span class="keyword">from</span> torchvision.transforms <span class="keyword">import</span> ToTensor</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.sampler <span class="keyword">import</span> SubsetRandomSampler</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">dataset = MNIST(root=<span class="string">&quot;./data&quot;</span>, download=<span class="literal">True</span>, transform=ToTensor())</span><br><span class="line">test_dataset = MNIST(root=<span class="string">&#x27;./data&#x27;</span>, train=<span class="literal">False</span>, transform=ToTensor())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_indices</span>(<span class="params">n, rate</span>):</span><br><span class="line">    <span class="comment"># create number of validation set</span></span><br><span class="line">    n_val = <span class="built_in">int</span>(n * rate)</span><br><span class="line">    <span class="comment"># create shuffled index from 0-n, with no repeat</span></span><br><span class="line">    idxs = np.random.permutation(n)</span><br><span class="line">    <span class="comment"># retuen (n_val,last) index and (first n_val) index</span></span><br><span class="line">    <span class="comment"># i.e. training index and validation index</span></span><br><span class="line">    <span class="keyword">return</span> idxs[n_val:], idxs[:n_val]</span><br><span class="line"></span><br><span class="line">train_indices, val_indices = split_indices(<span class="built_in">len</span>(dataset), <span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">100</span></span><br><span class="line">train_sampler = SubsetRandomSampler(train_indices)</span><br><span class="line">train_loder = DataLoader(dataset,</span><br><span class="line">                         batch_size,</span><br><span class="line">                         sampler=train_sampler)</span><br><span class="line"></span><br><span class="line">val_sampler = SubsetRandomSampler(val_indices)</span><br><span class="line">val_loder = DataLoader(dataset,</span><br><span class="line">                       batch_size,</span><br><span class="line">                       sampler=val_sampler)</span><br><span class="line"></span><br><span class="line">input_size = <span class="number">28</span> * <span class="number">28</span></span><br><span class="line">num_classes = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MnistModel</span>(nn.Module):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_size, hidden_size, out_size</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.linear1 = nn.Linear(in_size, hidden_size)</span><br><span class="line"></span><br><span class="line">        self.linear2 = nn.Linear(hidden_size, out_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, xb</span>):</span><br><span class="line">        <span class="comment"># flatten</span></span><br><span class="line">        xb = xb.view(xb.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># xb = xb.reshape(xb.size(0), -1)</span></span><br><span class="line">        <span class="keyword">return</span> self.linear2(F.relu(self.linear1(xb)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># for t in model.parameters():</span></span><br><span class="line"><span class="comment">#     print(t.shape)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for img, labels in train_loder:</span></span><br><span class="line"><span class="comment">#     outputs = model(img)</span></span><br><span class="line"><span class="comment">#     loss = F.cross_entropy(outputs, labels)</span></span><br><span class="line"><span class="comment">#     break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_device</span>():</span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        <span class="keyword">return</span> torch.device(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> torch.device(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_device</span>(<span class="params">data, device</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)):</span><br><span class="line">        <span class="keyword">return</span> [to_device(x, device) <span class="keyword">for</span> x <span class="keyword">in</span> data]</span><br><span class="line">    <span class="keyword">return</span> data.to(device, non_blocking=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for img, label in train_loder:</span></span><br><span class="line"><span class="comment">#     print(img.shape)</span></span><br><span class="line"><span class="comment">#     img = to_device(img, device)</span></span><br><span class="line"><span class="comment">#     print(img.device)</span></span><br><span class="line"><span class="comment">#     break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeviceDataLoder</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dl, device</span>):</span><br><span class="line">        self.dl = dl</span><br><span class="line">        self.device = device</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># lazy load here</span></span><br><span class="line">        <span class="comment"># instead of load data into device each time, instead, load each batch</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> self.dl:</span><br><span class="line">            <span class="keyword">yield</span> to_device(b, self.device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.dl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># use DeviceDataLoader as warpper</span></span><br><span class="line">train_dl = DeviceDataLoder(train_loder, get_device())</span><br><span class="line">valid_dl = DeviceDataLoder(val_loder, get_device())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loss_batch</span>(<span class="params">model, loss_func, xb, yb, opt=<span class="literal">None</span>, metric=<span class="literal">None</span></span>):</span><br><span class="line">    preds = model(xb)</span><br><span class="line"></span><br><span class="line">    loss = loss_func(preds, yb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opt <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        loss.backward()</span><br><span class="line">        opt.step()</span><br><span class="line">        opt.zero_grad()</span><br><span class="line"></span><br><span class="line">    metric_result = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        metric_result = metric(preds, yb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss.item(), <span class="built_in">len</span>(xb), metric_result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">model, loss_func, valid_dl, metric=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        results = [loss_batch(model, loss_func, xb, yb, metric=metric)</span><br><span class="line">                   <span class="keyword">for</span> xb, yb <span class="keyword">in</span> valid_dl]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># separate the lists</span></span><br><span class="line">        loss, nums, metric = <span class="built_in">zip</span>(*results)</span><br><span class="line">        total = np.<span class="built_in">sum</span>(nums)</span><br><span class="line">        avg_loss = np.<span class="built_in">sum</span>(np.multiply(loss, nums)) / total</span><br><span class="line">        avg_metric = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            avg_metric = np.<span class="built_in">sum</span>(np.multiply(metric, nums)) / total</span><br><span class="line">    <span class="keyword">return</span> avg_loss, total, avg_metric</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">epochs, lr, model, loss_func, train_dl, valid_dl, opt_fn=<span class="literal">None</span>, metric=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> opt_fn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        opt_fn = torch.optim.SGD</span><br><span class="line">    opt = opt_fn(model.parameters(), lr=lr)</span><br><span class="line">    loss_history = []</span><br><span class="line">    metric_history = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        <span class="keyword">for</span> xb, yb <span class="keyword">in</span> train_dl:</span><br><span class="line">            loss_batch(model, loss_func, xb, yb, opt)</span><br><span class="line">        result = evaluate(model, loss_func, valid_dl, metric)</span><br><span class="line">        val_loss, total, val_metric = result</span><br><span class="line"></span><br><span class="line">        loss_history.append(val_loss)</span><br><span class="line">        metric_history.append(val_metric)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;epochs&#125;</span>], Loss: <span class="subst">&#123;val_loss:<span class="number">.4</span>f&#125;</span>, Metric: <span class="subst">&#123;val_metric:<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;epochs&#125;</span>], Loss: <span class="subst">&#123;val_loss:<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss_history, metric_history</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accuracy</span>(<span class="params">output, label</span>):</span><br><span class="line">    _, preds = torch.<span class="built_in">max</span>(output, dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> torch.<span class="built_in">sum</span>(label == preds).item() / <span class="built_in">len</span>(preds)</span><br><span class="line"></span><br><span class="line">model = MnistModel(input_size, <span class="number">32</span>, num_classes)</span><br><span class="line">to_device(model, get_device())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> path.exists(<span class="string">&#x27;./tutorial5/mnist-logistic.pth&#x27;</span>):</span><br><span class="line">    model.load_state_dict(torch.load(<span class="string">&#x27;./tutorial5/mnist-logistic.pth&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    loss_history, metric_history = fit(<span class="number">5</span>, <span class="number">0.5</span>, model, F.cross_entropy,</span><br><span class="line">                                       train_dl,</span><br><span class="line">                                       valid_dl,</span><br><span class="line">                                       opt_fn=torch.optim.SGD,</span><br><span class="line">                                       metric=accuracy)</span><br><span class="line">    <span class="comment"># it will save the weight and bias for this model</span></span><br><span class="line">    <span class="comment"># new dir</span></span><br><span class="line">    mkdir(<span class="string">&#x27;./tutorial5&#x27;</span>)</span><br><span class="line">    torch.save(model.state_dict(), <span class="string">&#x27;./tutorial5/mnist-logistic.pth&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prediction_img</span>(<span class="params">img, model</span>):</span><br><span class="line">    xb = img.unsqueeze(<span class="number">0</span>)</span><br><span class="line">    yb = model(xb)</span><br><span class="line">    _, preds = torch.<span class="built_in">max</span>(yb, dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> preds[<span class="number">0</span>].item()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    img, label = test_dataset[randint(<span class="number">0</span>, <span class="built_in">len</span>(test_dataset) - <span class="number">1</span>)]</span><br><span class="line">    img_np = np.array(img)</span><br><span class="line">    plt.imshow(img_np.squeeze(), cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    <span class="built_in">print</span>(prediction_img(img, model))</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-21T16:42:44.000Z" title="12/22/2023, 3:42:44 AM">2023-12-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T01:29:08.569Z" title="6/20/2024, 11:29:08 AM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Pytorch-Introduction/">Pytorch Introduction</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/22/Tutorial%203/">Pytorch Tutorial 3</a></p><div class="content"><p>simple linear regression with bulit in tools in pytorch</p>
<ol>
<li>generate prediction</li>
<li>calculate the loss</li>
<li>compute gradients of w and b</li>
<li>adjust w and b</li>
<li>reset gradients to zero</li>
</ol>
<p>these 5 steps also respect to the loop in the next function</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> TensorDataset</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># temp, rainfall, humidity</span></span><br><span class="line"><span class="comment"># inputs = torch.tensor(np.random.uniform(0, 120, size=(15, 3)))</span></span><br><span class="line"><span class="comment"># the input and output here need to specify the dtype, otherwise, when torch generate the prediction,</span></span><br><span class="line"><span class="comment"># it will encounter the problem of dtype is not match</span></span><br><span class="line">inputs = torch.tensor(np.array(</span><br><span class="line">    [[<span class="number">109.4144</span>, <span class="number">11.2775</span>, <span class="number">32.4521</span>], [<span class="number">2.0002</span>, <span class="number">47.0248</span>, <span class="number">49.9469</span>], [<span class="number">27.1528</span>, <span class="number">57.8907</span>, <span class="number">91.2076</span>],</span><br><span class="line">     [<span class="number">44.8227</span>, <span class="number">71.6239</span>, <span class="number">64.0752</span>], [<span class="number">66.0968</span>, <span class="number">92.5966</span>, <span class="number">94.0775</span>], [<span class="number">59.6257</span>, <span class="number">76.9701</span>, <span class="number">92.1656</span>],</span><br><span class="line">     [<span class="number">8.1551</span>, <span class="number">1.7426</span>, <span class="number">10.5297</span>], [<span class="number">112.6036</span>, <span class="number">47.2793</span>, <span class="number">95.4221</span>], [<span class="number">3.2212</span>, <span class="number">61.8274</span>, <span class="number">115.9187</span>],</span><br><span class="line">     [<span class="number">35.0351</span>, <span class="number">110.6133</span>, <span class="number">66.6992</span>], [<span class="number">8.8387</span>, <span class="number">21.8008</span>, <span class="number">50.0480</span>], [<span class="number">68.7698</span>, <span class="number">59.9815</span>, <span class="number">12.0230</span>],</span><br><span class="line">     [<span class="number">111.3881</span>, <span class="number">90.3050</span>, <span class="number">62.1327</span>], [<span class="number">101.7462</span>, <span class="number">115.7447</span>, <span class="number">33.4925</span>], [<span class="number">27.7659</span>, <span class="number">54.5803</span>, <span class="number">105.3599</span>]], dtype=<span class="string">&#x27;float32&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># apples, oranges</span></span><br><span class="line"><span class="comment"># targets = torch.tensor(np.random.uniform(0, 50, size=(15, 2)))</span></span><br><span class="line">targets = torch.tensor(np.array(</span><br><span class="line">    [[<span class="number">28.1090</span>, <span class="number">45.0061</span>], [<span class="number">29.0839</span>, <span class="number">6.4205</span>], [<span class="number">35.2633</span>, <span class="number">44.1196</span>],</span><br><span class="line">     [<span class="number">29.5371</span>, <span class="number">6.8457</span>], [<span class="number">7.4298</span>, <span class="number">36.1434</span>], [<span class="number">6.6296</span>, <span class="number">47.1809</span>],</span><br><span class="line">     [<span class="number">49.9750</span>, <span class="number">49.9321</span>], [<span class="number">34.1796</span>, <span class="number">16.6732</span>], [<span class="number">46.8875</span>, <span class="number">7.6084</span>],</span><br><span class="line">     [<span class="number">23.0442</span>, <span class="number">42.2229</span>], [<span class="number">29.7401</span>, <span class="number">13.4199</span>], [<span class="number">3.0854</span>, <span class="number">21.4550</span>],</span><br><span class="line">     [<span class="number">47.6801</span>, <span class="number">49.1518</span>], [<span class="number">18.7320</span>, <span class="number">18.4418</span>], [<span class="number">34.2725</span>, <span class="number">25.8721</span>]], dtype=<span class="string">&#x27;float32&#x27;</span>))</span><br><span class="line"><span class="comment"># print(inputs)</span></span><br><span class="line"><span class="comment"># print(targets)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TensorDataset will creat the structure of pairing (input and target) accordingly</span></span><br><span class="line">train_ds = TensorDataset(inputs, targets)</span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">5</span></span><br><span class="line">train_dl = DataLoader(train_ds, batch_size, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Each batch size is 5, and the data are shuffled</span></span><br><span class="line"><span class="comment"># and is still can contain the pair of data, the structure won&#x27;t be shuffled</span></span><br><span class="line"><span class="comment"># for xb, yb in train_dl:</span></span><br><span class="line"><span class="comment">#     print(&quot;batch:&quot;)</span></span><br><span class="line"><span class="comment">#     print(xb)</span></span><br><span class="line"><span class="comment">#     print(yb)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify the input and output feature number</span></span><br><span class="line">model = nn.Linear(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># the weight and bias will be initialed automatically, and the parameter of requires_grad will be set as True</span></span><br><span class="line"><span class="comment"># print(model.weight)</span></span><br><span class="line"><span class="comment"># print(model.bias)</span></span><br><span class="line"><span class="comment"># print(list(model.parameters()))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># preds = model(inputs)</span></span><br><span class="line"><span class="comment"># print(preds)</span></span><br><span class="line"></span><br><span class="line">loss_fn = F.mse_loss</span><br><span class="line">loss = loss_fn(model(inputs), targets)</span><br><span class="line"><span class="comment"># print(loss)</span></span><br><span class="line"></span><br><span class="line">opt = torch.optim.SGD(model.parameters(), lr=<span class="number">1e-5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 generate prediction</span></span><br><span class="line"><span class="comment"># 2 calculate the loss</span></span><br><span class="line"><span class="comment"># 3 compute gradients of w and b</span></span><br><span class="line"><span class="comment"># 4 adjust w and b</span></span><br><span class="line"><span class="comment"># 5 reset gradients to zero</span></span><br><span class="line"><span class="comment"># these 5 steps also respect to the loop in the next function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">num_epochs, model, loss_fn, opt</span>):</span><br><span class="line">    <span class="comment"># training interation</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        <span class="comment"># batches in each interation</span></span><br><span class="line">        <span class="keyword">for</span> xb, yb <span class="keyword">in</span> train_dl:</span><br><span class="line">            pred = model(xb)</span><br><span class="line">            loss = loss_fn(pred, yb)</span><br><span class="line">            loss.backward()</span><br><span class="line">            opt.step()</span><br><span class="line">            opt.zero_grad()</span><br><span class="line">        <span class="keyword">if</span> (epoch+<span class="number">1</span>) % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Epoch [&#123;&#125;/&#123;&#125;], Loss: &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(epoch+<span class="number">1</span>, num_epochs, loss.item()))</span><br><span class="line"></span><br><span class="line">fit(<span class="number">100</span>, model, loss_fn, opt)</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-21T09:46:25.000Z" title="12/21/2023, 8:46:25 PM">2023-12-21</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-08-08T14:05:34.490Z" title="8/9/2024, 12:05:34 AM">2024-08-09</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Pytorch-Introduction/">Pytorch Introduction</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/21/Tutorial%204/">Pytorch Tutorial 4</a></p><div class="content"><ol>
<li>load dataset<ol>
<li>transform the data into tensor</li>
</ol>
</li>
<li>split the dataset into training, testing, validation datasets<ol>
<li>define the function of indices shuffle (the dataset are ordered, if missing apply the shuffle, the individual dataset may only contains one label)</li>
<li>create sampler and loader</li>
</ol>
</li>
<li>customise the MnistModel function</li>
<li>define loss_batch<ol>
<li>calculate loss in current batch</li>
</ol>
</li>
<li>define evaluate<ol>
<li>calculate average loss in batches</li>
</ol>
</li>
<li>define accuracy<ol>
<li>also called metric to shows the accuracy</li>
</ol>
</li>
<li>create fit function<ol>
<li>epoch loop<ol>
<li>train loop<ol>
<li>loss_batch  — for train</li>
</ol>
</li>
<li>evaluate result</li>
<li>print result</li>
</ol>
</li>
</ol>
</li>
<li>call fit</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">from</span> torchvision.datasets <span class="keyword">import</span> MNIST</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.sampler <span class="keyword">import</span> SubsetRandomSampler</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># transoforms used to transform the MNIST dataset into tensor in order to torch can work with</span></span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"></span><br><span class="line"><span class="comment"># here the datasets in original format, can not be understood by torch</span></span><br><span class="line">datasets = MNIST(root=<span class="string">&#x27;./data&#x27;</span>, download=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># print(len(datasets))</span></span><br><span class="line"></span><br><span class="line">test_dataset = MNIST(root=<span class="string">&#x27;./data&#x27;</span>, train=<span class="literal">False</span>, transform=transforms.ToTensor())</span><br><span class="line"><span class="comment"># print(len(test_dataset))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># img, label = datasets[0]</span></span><br><span class="line"><span class="comment"># plt.imshow(img, cmap=&#x27;gray&#x27;)</span></span><br><span class="line"><span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(label)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># here the dataset is already transformed into tensor</span></span><br><span class="line">dataset = MNIST(root=<span class="string">&#x27;./data&#x27;</span>, download=<span class="literal">True</span>, transform=transforms.ToTensor())</span><br><span class="line"></span><br><span class="line"><span class="comment"># the shape here is 1,28,28, color, height, weight</span></span><br><span class="line"><span class="comment"># img_tensor, label = dataset[0]</span></span><br><span class="line"><span class="comment"># print(img_tensor.shape, label)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(img_tensor[:, 10:15, 10:15])</span></span><br><span class="line"><span class="comment"># print(torch.max(img_tensor), torch.min(img_tensor))</span></span><br><span class="line"><span class="comment"># plt.imshow(img_tensor[0, 10:15, 10:15], cmap=&#x27;gray&#x27;)</span></span><br><span class="line"><span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_indices</span>(<span class="params">n, rate</span>):</span><br><span class="line">    <span class="comment"># create number of validation set</span></span><br><span class="line">    n_val = <span class="built_in">int</span>(n * rate)</span><br><span class="line">    <span class="comment"># create shuffled index from 0-n, with no repeat</span></span><br><span class="line">    idxs = np.random.permutation(n)</span><br><span class="line">    <span class="comment"># retuen (n_val,last) index and (first n_val) index</span></span><br><span class="line">    <span class="comment"># i.e. training index and validation index</span></span><br><span class="line">    <span class="keyword">return</span> idxs[n_val:], idxs[:n_val]</span><br><span class="line"></span><br><span class="line">train_indices, val_indices = split_indices(<span class="built_in">len</span>(dataset), <span class="number">0.2</span>)</span><br><span class="line"><span class="comment"># print(len(train_indices), len(val_indices))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the sampler here is randomly select the indices from list with number of batch_size</span></span><br><span class="line"><span class="comment"># the reason for this is lower down the training time and computation</span></span><br><span class="line"><span class="comment"># and utilize multiple epoch to train the model, if not, the training will deal with whole data set,</span></span><br><span class="line"><span class="comment"># that will occupy too much memory space and make too much pressure to computational resources.</span></span><br><span class="line"><span class="comment"># in this case, the training process will transfer to smaller chucks</span></span><br><span class="line">batch_size = <span class="number">100</span></span><br><span class="line">train_sampler = SubsetRandomSampler(train_indices)</span><br><span class="line">train_loder = DataLoader(dataset,</span><br><span class="line">                         batch_size,</span><br><span class="line">                         sampler=train_sampler)</span><br><span class="line"></span><br><span class="line">val_sampler = SubsetRandomSampler(val_indices)</span><br><span class="line">val_loder = DataLoader(dataset,</span><br><span class="line">                       batch_size,</span><br><span class="line">                       sampler=val_sampler)</span><br><span class="line"></span><br><span class="line">input_size = <span class="number">28</span> * <span class="number">28</span></span><br><span class="line">num_classes = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># model = nn.Linear(input_size, num_classes)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(model.weight.shape)</span></span><br><span class="line"><span class="comment"># print(model.bias.shape)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print(model.weight)</span></span><br><span class="line"><span class="comment"># print(model.bias)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for img, label in train_loder:</span></span><br><span class="line"><span class="comment">#     print(img.shape)</span></span><br><span class="line"><span class="comment">#     print(label)</span></span><br><span class="line"><span class="comment">#     # there is a error, the shape of image is 1*28*28, but the received input shape was set 784</span></span><br><span class="line"><span class="comment">#     # so, the customized model are needed.</span></span><br><span class="line"><span class="comment">#     print(model(img))</span></span><br><span class="line"><span class="comment">#     break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MnistModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># define the input and output for linear</span></span><br><span class="line">        self.linear = nn.Linear(input_size, num_classes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, xb</span>):</span><br><span class="line">        <span class="comment"># reshape -1 here avoid the hard code, it will calculate the first dimension number</span></span><br><span class="line">        xb = xb.reshape(-<span class="number">1</span>, input_size)</span><br><span class="line">        <span class="comment"># pass the batch data to linear layer</span></span><br><span class="line">        out = self.linear(xb)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">model = MnistModel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># the weight and bias are in the linear(model.linear.weight), instead of the model above(model.weight)</span></span><br><span class="line"><span class="comment"># print(model.linear.weight.shape)</span></span><br><span class="line"><span class="comment"># print(model.linear.bias.shape)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># print(model.linear.weight)</span></span><br><span class="line"><span class="comment"># print(model.linear.bias)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accuracy</span>(<span class="params">l1, l2</span>):</span><br><span class="line">    <span class="keyword">return</span> torch.<span class="built_in">sum</span>(l1 == l2).item() / <span class="built_in">len</span>(l2)</span><br></pre></td></tr></table></figure>

<p>Log plot presentation</p>
<p><img src="https://zjsygqs398.github.io/blog/my_img/tut4/log.png" alt="Untitled"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for img, label in train_loder:</span></span><br><span class="line"><span class="comment"># the img pass in the model shape is 100,1,28,28</span></span><br><span class="line"><span class="comment"># the output shape is 100,10</span></span><br><span class="line"><span class="comment"># which reaches what we expected (represent the 0-9 digital number)</span></span><br><span class="line"><span class="comment"># here the softmax can be introduced to show the possibility with each number correspondingly</span></span><br><span class="line"><span class="comment"># possibility = e^y_i / sum(e^y_i)</span></span><br><span class="line"><span class="comment"># outputs = model(img)</span></span><br><span class="line"><span class="comment"># the second parameter here indicates the dim index need to be applied</span></span><br><span class="line"><span class="comment"># so 0 means the column direction, and 1 for row direction for 2D matrix</span></span><br><span class="line"><span class="comment"># probs = F.softmax(outputs, 1)</span></span><br><span class="line"><span class="comment"># print(probs.shape)</span></span><br><span class="line"><span class="comment"># so now the probs shape is 100,10, but each value each row represent possibility(0-1), and sum of each row is 1</span></span><br><span class="line"><span class="comment"># print(outputs.shape)</span></span><br><span class="line"><span class="comment"># print(outputs[0])</span></span><br><span class="line"><span class="comment"># max_probs, predicted_labels = torch.max(probs, 1)</span></span><br><span class="line"><span class="comment"># print(accuracy(predicted_labels, label))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now, we need to define the loss function</span></span><br><span class="line"><span class="comment"># here the cross entropy is most suitable for logistic regression</span></span><br><span class="line"><span class="comment"># i.e.</span></span><br><span class="line"><span class="comment"># the true label 9 is represented vector of [0,0,0,0,0,0,0,0,0,1]</span></span><br><span class="line"><span class="comment"># the predict vector [0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9] for instance</span></span><br><span class="line"><span class="comment"># and the cross entropy is -ln(y*y_pred) i.e. -ln(1*0.9) = 0.10, which is low</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># but, when the prediction is poor</span></span><br><span class="line"><span class="comment"># the true label 1 is represented vector of [0,1,0,0,0,0,0,0,0,0]</span></span><br><span class="line"><span class="comment"># the predict vector [0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9] for instance</span></span><br><span class="line"><span class="comment"># and the cross entropy is -ln(y*y_pred) i.e. -ln(1*0.2) = 1.6, which is high</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in the cross entropy, we only consider the right label, and ignore the other, because their vector is 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># so when low possibility for the correct number the cross entropy(loss) is high, v.v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># define the loss function for current batch</span></span><br><span class="line"><span class="comment"># loss = F.cross_entropy(outputs, label)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># the equation here is -e.pow(right prediction possibility)=loss</span></span><br><span class="line"><span class="comment"># so the right possibility is e.pow(-loss)</span></span><br><span class="line"><span class="comment"># learn_rate = 0.001</span></span><br><span class="line"><span class="comment"># optimizer = torch.optim.SGD(model.parameters(), lr=learn_rate)</span></span><br><span class="line"><span class="comment"># optimizer.step()</span></span><br><span class="line"><span class="comment"># break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loss_batch</span>(<span class="params">model, loss_func, xb, yb, opt=<span class="literal">None</span>, metric=<span class="literal">None</span></span>):</span><br><span class="line">    preds = model(xb)</span><br><span class="line">    loss = loss_func(preds, yb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opt <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        loss.backward()</span><br><span class="line">        opt.step()</span><br><span class="line">        opt.zero_grad()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># metric is used for model evaluation</span></span><br><span class="line">    metric_result = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        metric_result = metric(preds, yb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss.item(), <span class="built_in">len</span>(xb), metric_result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">model, loss_func, valid_dl, metric=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        results = [loss_batch(model, loss_func, xb, yb, metric=metric)</span><br><span class="line">                   <span class="keyword">for</span> xb, yb <span class="keyword">in</span> valid_dl]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># separate the lists</span></span><br><span class="line">        loss, nums, metric = <span class="built_in">zip</span>(*results)</span><br><span class="line">        total = np.<span class="built_in">sum</span>(nums)</span><br><span class="line">        avg_loss = np.<span class="built_in">sum</span>(np.multiply(loss, nums)) / total</span><br><span class="line">        avg_metric = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            avg_metric = np.<span class="built_in">sum</span>(np.multiply(metric, nums)) / total</span><br><span class="line">    <span class="keyword">return</span> avg_loss, total, avg_metric</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accuracy</span>(<span class="params">output, label</span>):</span><br><span class="line">    _, preds = torch.<span class="built_in">max</span>(output, dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> torch.<span class="built_in">sum</span>(label == preds).item() / <span class="built_in">len</span>(preds)</span><br><span class="line"></span><br><span class="line"><span class="comment"># avg_loss, total, val_acc = evaluate(model, F.cross_entropy, val_loder, metric=accuracy)</span></span><br><span class="line"><span class="comment"># print(&quot;Loss: &#123;:.4f&#125;, total:&#123;:.4f&#125;, Accuracy: &#123;:.4f&#125;&quot;.format(avg_loss, total, val_acc))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">epochs, model, loss_fn, opt, train_dl, valid_dl, metric=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        <span class="keyword">for</span> xb, yb <span class="keyword">in</span> train_dl:</span><br><span class="line">            loss, _, _ = loss_batch(model, loss_fn, xb, yb, opt, metric=metric)</span><br><span class="line"></span><br><span class="line">        result = evaluate(model, loss_fn, valid_dl, metric=metric)</span><br><span class="line">        val_loss, total, val_metric = result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> metric <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Epoch [&#123;&#125;/&#123;&#125;], total:&#123;:.4f&#125;, Loss: &#123;:.4f&#125;&quot;</span></span><br><span class="line">                  .<span class="built_in">format</span>(epoch + <span class="number">1</span>, epochs, total, val_loss, val_metric))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Epoch [&#123;&#125;/&#123;&#125;], total:&#123;:.4f&#125;, Loss: &#123;:.4f&#125;, &#123;&#125;: &#123;:.4f&#125;&quot;</span></span><br><span class="line">                  .<span class="built_in">format</span>(epoch + <span class="number">1</span>, epochs, total, val_loss, metric.__name__, val_metric))</span><br><span class="line"></span><br><span class="line">model = MnistModel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># if path is not blank</span></span><br><span class="line"><span class="keyword">if</span> path.exists(<span class="string">&#x27;mnist-logistic.pth&#x27;</span>):</span><br><span class="line">    model.load_state_dict(torch.load(<span class="string">&#x27;mnist-logistic.pth&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    fit(<span class="number">5</span>,</span><br><span class="line">        model,</span><br><span class="line">        F.cross_entropy,</span><br><span class="line">        torch.optim.SGD(model.parameters(), lr=<span class="number">0.001</span>),</span><br><span class="line">        train_loder,</span><br><span class="line">        val_loder,</span><br><span class="line">        metric=accuracy)</span><br><span class="line">    <span class="comment"># it will save the weight and bias for this model</span></span><br><span class="line">    torch.save(model.state_dict(), <span class="string">&#x27;mnist-logistic.pth&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read the saved model into instance</span></span><br><span class="line"><span class="comment"># model2 = MnistModel()</span></span><br><span class="line"><span class="comment"># model2.load_state_dict(torch.load(&#x27;mnist-logistic.pth&#x27;))</span></span><br><span class="line"><span class="comment"># model2.state_dict()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prediction_img</span>(<span class="params">img, model</span>):</span><br><span class="line">    xb = img.unsqueeze(<span class="number">0</span>)</span><br><span class="line">    yb = model(xb)</span><br><span class="line">    _, preds = torch.<span class="built_in">max</span>(yb, dim=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> preds[<span class="number">0</span>].item()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    img, label = test_dataset[randint(<span class="number">0</span>, <span class="built_in">len</span>(test_dataset) - <span class="number">1</span>)]</span><br><span class="line">    img_np = np.array(img)</span><br><span class="line">    plt.imshow(img_np.squeeze(), cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line">    <span class="built_in">print</span>(prediction_img(img, model))</span><br></pre></td></tr></table></figure>

<h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><ol>
<li>when import test_dataset missing the parameter of transform, made the validation section encounter the problem of <code>img no squeeze parameter</code></li>
<li>zip(*results), used for unpack the tuples, and pass into multiple instances</li>
<li><code>avg_loss = np.sum(np.multiply(loss, nums)) / total</code> the reason use multiply here is for last batch number, is might not equals to previous number</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-19T15:34:48.000Z" title="12/20/2023, 2:34:48 AM">2023-12-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T01:29:04.720Z" title="6/20/2024, 11:29:04 AM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Pytorch-Introduction/">Pytorch Introduction</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/20/Tutorial%201/">Pytorch Tutorial 1</a></p><div class="content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">t1 = torch.tensor(<span class="number">4.</span>)</span><br><span class="line"><span class="built_in">print</span>(t1)</span><br><span class="line"><span class="built_in">print</span>(t1.dtype)</span><br><span class="line"></span><br><span class="line">t2 = torch.tensor([<span class="number">1.</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(t2)</span><br><span class="line"><span class="built_in">print</span>(t2.dtype)</span><br><span class="line"><span class="comment"># in this case the all data will be transformed to same data type</span></span><br><span class="line"><span class="comment"># [1., 2., 3., 4.]</span></span><br><span class="line"></span><br><span class="line">t3 = torch.tensor([<span class="number">1.</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(t3)</span><br><span class="line"><span class="built_in">print</span>(t3.dtype)</span><br><span class="line"></span><br><span class="line">t4 = torch.tensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">1.</span>, <span class="number">4</span>], [<span class="number">4</span>, <span class="number">3</span>], [<span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(t4)</span><br><span class="line"><span class="built_in">print</span>(t4.dtype)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(t1.shape)</span><br><span class="line"><span class="built_in">print</span>(t2.shape)</span><br><span class="line"><span class="built_in">print</span>(t3.shape)</span><br><span class="line"><span class="built_in">print</span>(t4.shape)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line">x = torch.tensor(<span class="number">3.</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line">w = torch.tensor(<span class="number">4.</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line">b = torch.tensor(<span class="number">5.</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">y = w * x + b</span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line">y.backward()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x.grad)</span><br><span class="line"><span class="built_in">print</span>(w.grad)</span><br><span class="line"><span class="built_in">print</span>(b.grad)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  convert numpy to torch</span></span><br><span class="line">x = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">2</span>, <span class="number">4</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># use shared memory space, not copy</span></span><br><span class="line">y = torch.from_numpy(x)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  copy data</span></span><br><span class="line">y = torch.tensor(x)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line"><span class="built_in">print</span>(y.dtype)</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert torch to numpy</span></span><br><span class="line">z = y.numpy()</span><br><span class="line"><span class="built_in">print</span>(z)</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-19T15:34:48.000Z" title="12/20/2023, 2:34:48 AM">2023-12-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-06-20T01:29:06.834Z" title="6/20/2024, 11:29:06 AM">2024-06-20</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Pytorch-Introduction/">Pytorch Introduction</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/20/Tutorial%202/">Pytorch Tutorial 2</a></p><div class="content"><p>simple linear regression with auto gradient method in pytorch</p>
<ol>
<li><code>@</code> means inner dot</li>
<li><code>.t()</code> means transpose matrix</li>
<li><code>.numel()</code> means number of element in matrix</li>
<li><code>with torch.no_grad()</code> means code insider this block will not track gradients to save memory and computation time</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">inputs = np.array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>],</span><br><span class="line">                   [<span class="number">0</span>, <span class="number">1</span>, <span class="number">9</span>],</span><br><span class="line">                   [<span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>],</span><br><span class="line">                   [<span class="number">1</span>, <span class="number">1</span>, <span class="number">28</span>]], dtype=<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">outputs = np.array([[<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">                    [<span class="number">9</span>, <span class="number">4</span>],</span><br><span class="line">                    [<span class="number">7</span>, <span class="number">3</span>],</span><br><span class="line">                    [<span class="number">6</span>, <span class="number">7</span>]], dtype=<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">inputs = torch.from_numpy(inputs)</span><br><span class="line">outputs = torch.from_numpy(outputs)</span><br><span class="line"></span><br><span class="line">w = torch.randn(<span class="number">2</span>, <span class="number">3</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line">b = torch.randn(<span class="number">2</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(b)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="comment"># the b is the vector, when the matrix plus b, the b will be copy bunch of data to make it as the matrix</span></span><br><span class="line">    <span class="keyword">return</span> x @ w.t() + b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mse</span>(<span class="params">t1, t2</span>):</span><br><span class="line">    <span class="keyword">return</span> torch.<span class="built_in">sum</span>((t1 - t2) ** <span class="number">2</span>) / t1.numel()</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-5</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">500</span>):</span><br><span class="line">    y_pred = model(inputs)</span><br><span class="line">    loss = mse(y_pred, outputs)</span><br><span class="line">    loss.backward()</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        w -= learning_rate * w.grad</span><br><span class="line">        b -= learning_rate * b.grad</span><br><span class="line">        w.grad.zero_()</span><br><span class="line">        b.grad.zero_()</span><br><span class="line">    <span class="built_in">print</span>(loss.item())</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-18T06:19:50.675Z" title="12/18/2023, 5:19:50 PM">2023-12-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-10-25T03:19:43.172Z" title="10/25/2022, 2:19:43 PM">2022-10-25</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Internship/">Internship</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/18/shiro%E5%AE%9E%E7%8E%B0%E6%9D%83%E9%99%90/">Shiro</a></p><div class="content"><h1 id="shiro实现权限"><a href="#shiro实现权限" class="headerlink" title="shiro实现权限"></a>shiro实现权限</h1><h2 id="其他框架："><a href="#其他框架：" class="headerlink" title="其他框架："></a>其他框架：</h2><p>sprintSecurity（还未研究，据说类似）</p>
<h2 id="配置步骤："><a href="#配置步骤：" class="headerlink" title="配置步骤："></a>配置步骤：</h2><ol>
<li>导入maven</li>
<li>添加ShiroConfig</li>
<li>创建UserRealm</li>
</ol>
<h2 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h2><ul>
<li>在过滤器创建的时候是 LinkedHashMap 千万注意， 不然通配符不会匹配，会被覆盖掉</li>
<li>过滤器创建时可设置未授权跳转页面，不适用于分离项目</li>
<li>过滤工厂创建的时候可以放入自定义拦截器，用于项目自己的业务</li>
<li>可以在subject.login()之前，通过对session设置来修改登录过期时间</li>
</ul>
<h2 id="核心："><a href="#核心：" class="headerlink" title="核心："></a>核心：</h2><ul>
<li>Subject 获取当前对象</li>
<li>token可用username，password生成</li>
<li>可使用Md5Hash进行加密</li>
<li>在调用login后通过捕获异常来区别不同的登录情况</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jcDemo.interceptor.MyFormAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/21- 10:57</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;filterShiroFilterRegistrationBean&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;SecurityManager&quot;)</span> DefaultWebSecurityManager defaultWebSecurityManager)</span> &#123;</span><br><span class="line">        <span class="comment">//1.创建过滤工厂</span></span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        filters.put(<span class="string">&quot;MyFormAuthenticationFilter&quot;</span>, <span class="keyword">new</span> <span class="title class_">MyFormAuthenticationFilter</span>());</span><br><span class="line">        bean.setFilters(filters);</span><br><span class="line">        <span class="comment">//2.设置安全管理器</span></span><br><span class="line">        bean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.配置未授权跳转页面</span></span><br><span class="line"><span class="comment">//        bean.setLoginUrl(&quot;/test&quot;);</span></span><br><span class="line"><span class="comment">//        bean.setLoginUrl(null);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.设置filter</span></span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        filterMap.put(<span class="string">&quot;/api/user/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        filterMap.put(<span class="string">&quot;/api/**&quot;</span>, <span class="string">&quot;MyFormAuthenticationFilter&quot;</span>);</span><br><span class="line"></span><br><span class="line">        bean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;SecurityManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm)</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(userRealm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启shiro注解</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启aop注解支持</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">defaultAAP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">        defaultAAP.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAAP;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.entities.User;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.vo.UidUsernameName;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.service.user.RoleService;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.service.user.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/21- 10:07</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RoleService roleService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;执行====================授权&quot;</span>);</span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Object data = roleService.getUserRoleById(1).getData();</span></span><br><span class="line"><span class="comment">//        info.addStringPermission(&quot;&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) subject.getPrincipal(); <span class="comment">//下面方法传上来的user对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取当前用户的权限数组</span></span><br><span class="line">        List&lt;UidUsernameName&gt; uidUsernameName = (List&lt;UidUsernameName&gt;) roleService.getUserRoleById(user.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历添加权限</span></span><br><span class="line">        uidUsernameName.forEach(e -&gt; &#123;</span><br><span class="line">            info.addStringPermission(e.getRoleName());</span><br><span class="line">            log.info(<span class="string">&quot;username:&#123;&#125;-------roleName:&#123;&#125;&quot;</span>, e.getUsername(), e.getRoleName());</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">userToken</span> <span class="operator">=</span> (UsernamePasswordToken) token;</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserByName(userToken.getUsername());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;认证&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"><span class="comment">//        subject.isPermitted(&quot;123&quot;);</span></span><br><span class="line"><span class="comment">//        subject.hasRole(&quot;authc&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        if(!userToken.getUsername().equals(user.getUsername()))&#123;</span></span><br><span class="line"><span class="comment">//            return null; //会在controller中捕获</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(user, user.getPassword(), <span class="string">&quot;&quot;</span>); <span class="comment">//验证密码</span></span><br><span class="line"><span class="comment">//        return null;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.res.Result;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.res.ResultCode;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.FormAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.ShiroHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/28- 10:07</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">FormAuthenticationFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">log.info(<span class="string">&quot;被shiro拦截啦=================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            out = response.getWriter();</span><br><span class="line">            <span class="keyword">if</span> (res.getStatus() == HttpServletResponse.SC_UNAUTHORIZED) &#123;</span><br><span class="line">                out.println(JSON.toJSONString(<span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.UNAUTHORISE)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isEmpty(((ShiroHttpServletRequest) request).getHeader(<span class="string">&quot;Authorization&quot;</span>))) &#123;</span><br><span class="line">log.info(<span class="string">&quot;未登录&quot;</span>);</span><br><span class="line">                    out.write(JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.UNAUTHENTICATED, <span class="string">&quot;&quot;</span>)));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;session已过期&quot;</span>);</span><br><span class="line">                    out.write(JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.EXPIREDSESSION, <span class="string">&quot;&quot;</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">log.info(<span class="string">&quot;session异常&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-18T06:19:50.663Z" title="12/18/2023, 5:19:50 PM">2023-12-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-10-25T03:19:52.380Z" title="10/25/2022, 2:19:52 PM">2022-10-25</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Internship/">Internship</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/18/%E6%95%B4%E5%90%88swagger/">整合swagger</a></p><div class="content"><h1 id="整合swagger"><a href="#整合swagger" class="headerlink" title="整合swagger"></a>整合swagger</h1><h2 id="Swagger简介"><a href="#Swagger简介" class="headerlink" title="Swagger简介"></a>Swagger简介</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/YR_112233/article/details/122630446">(12条消息) swagger使用教程——快速使用swagger_其实不会敲代码的博客-CSDN博客_swagger使用</a></p>
<h2 id="Step"><a href="#Step" class="headerlink" title="Step"></a>Step</h2><ol>
<li>maven依赖</li>
<li>配置SwaggerConfig（作者，项目名，邮件等）</li>
<li>启动后访问路径<a target="_blank" rel="noopener" href="http://localhost:8088/swagger-ui/index.html">Swagger UI</a></li>
</ol>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>实体类中<ul>
<li>@ApiModel类描述</li>
<li>@ApiModelProperty类中字段描述</li>
</ul>
</li>
<li>控制器中<ul>
<li>@Api控制器描述</li>
<li>@ApiOperation接口描述</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/22- 10:08</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.OAS_30).apiInfo(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                        .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;gqs&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">                        .title(<span class="string">&quot;JC_Demo&quot;</span>)</span><br><span class="line">                        .build()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-12-18T06:19:50.651Z" title="12/18/2023, 5:19:50 PM">2023-12-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-10-25T03:19:56.872Z" title="10/25/2022, 2:19:56 PM">2022-10-25</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/Internship/">Internship</a></span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/12/18/%E6%95%B4%E5%90%88redis%E7%BC%93%E5%AD%98/">整合redis缓存</a></p><div class="content"><h1 id="整合redis缓存"><a href="#整合redis缓存" class="headerlink" title="整合redis缓存"></a>整合redis缓存</h1><h2 id="分布式锁的实现和解析"><a href="#分布式锁的实现和解析" class="headerlink" title="分布式锁的实现和解析"></a>分布式锁的实现和解析</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kuan_sun/article/details/122713146">(12条消息) 分布式锁之Redis实现_kuan_sun的博客-CSDN博客_redis锁的实现</a></p>
<h2 id="整合步骤："><a href="#整合步骤：" class="headerlink" title="整合步骤："></a>整合步骤：</h2><ol>
<li>下载redis，解压，修改配置文件（redis.windows.conf）</li>
<li>导入redis启动依赖</li>
<li>创建redis配置类 （主要是对于kv的序列化和反序列化）</li>
<li>启动redis-server.exe （redis服务）（同时也可以通过指定配置文件进行启动—集群）</li>
<li>启动redis-cli.exe (操作客户端)</li>
</ol>
<h2 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h2><ul>
<li>HashMap不能设置过期时间！！！</li>
<li>使用device:No_001:Name 的方式来存放K</li>
<li>在存放value（对象）时 需要导入FastJson来进行操作</li>
<li>redis操作都在redisTemplate中，有很多操作，需要熟悉</li>
</ul>
<h2 id="引入缓存可能导致的问题（目前能想到的）"><a href="#引入缓存可能导致的问题（目前能想到的）" class="headerlink" title="引入缓存可能导致的问题（目前能想到的）"></a>引入缓存可能导致的问题（目前能想到的）</h2><ol>
<li>在修改后，需要对缓存进行操作，不然缓存中的数据有误<ol>
<li>在修改时判断是否有缓存 ？<ol>
<li>有：改缓存，利用缓存来修改持久层的（可以慢慢操作，在缓存失效之前操作完）</li>
<li>没有：修改持久层的，存缓存（有修改，一定马上会用到）</li>
</ol>
</li>
</ol>
</li>
<li>删除两边都得删</li>
<li>新增时添加缓存（新增也一定马上会用到）</li>
<li><strong>查找时：如果缓存有，是否需要更新过期时间？</strong></li>
<li><strong>分页需要做缓存吗，怎么做？</strong></li>
</ol>
<h2 id="可以改进的方向："><a href="#可以改进的方向：" class="headerlink" title="可以改进的方向："></a>可以改进的方向：</h2><ol>
<li>redis集群</li>
<li>锁<ol>
<li>利用redis中String来做<ol>
<li><p>setnx device:NO_001_Lock 1 ex time</p>
<p> <img src="/blog/%E6%95%B4%E5%90%88redis%E7%BC%93%E5%AD%98%202607652bb3da4be298d12edb5b3fb8e9/Untitled.png" alt="Untitled"></p>
</li>
<li><p>0则再用，重试请求；1进行业务操作</p>
</li>
<li><p>设置过期时间，避免设置锁后宕机死锁   时间需合适  </p>
<ol>
<li>太短：还没操作完就释放了</li>
<li>太长：已经操作完了 还锁着</li>
</ol>
</li>
<li><p>解决：线程守护</p>
<ol>
<li>设置一定时长</li>
<li>例设置10s 8s时判断是否还在执行？ 延长 ： 不延长</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.support.spring.data.redis.FastJsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericToStringSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/28- 13:41</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        FastJsonRedisSerializer&lt;Object&gt; objectFastJsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">FastJsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">//      自定义的RedisTemplate</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置key的序列化方法</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 核心的设置   1.2.36版本自动提供</span></span><br><span class="line">        redisTemplate.setValueSerializer(objectFastJsonRedisSerializer);</span><br><span class="line">        <span class="comment">//        对hash的序列化操作设置</span></span><br><span class="line">        redisTemplate.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        redisTemplate.setHashValueSerializer(objectFastJsonRedisSerializer);</span><br><span class="line">        <span class="comment">//        注册到工程类</span></span><br><span class="line">        redisTemplate.setConnectionFactory(factory);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ValueOperations&lt;String, Object&gt; <span class="title function_">valueOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HashOperations&lt;String, String, Object&gt; <span class="title function_">hashOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ListOperations&lt;String, Object&gt; <span class="title function_">listOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SetOperations&lt;String, Object&gt; <span class="title function_">setOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ZSetOperations&lt;String, Object&gt; <span class="title function_">zSetOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jcDemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.commom.CommonException;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.entities.Device;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.res.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.res.Result;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.entity.res.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.jcDemo.service.device.DeviceService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> lombok.<span class="keyword">var</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span>:gao_quansui</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@user</span>:ASUS</span></span><br><span class="line"><span class="comment">*<span class="doctag">@date</span>:2022/9/23- 10:51</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@projectName</span>:jc_demo</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;设备管理&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/device&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DeviceService deviceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查找所有设备&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getDevices&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getDevices</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;1&quot;)</span> <span class="type">int</span> pageNum,</span></span><br><span class="line"><span class="params">                             <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Page</span> <span class="variable">page</span> <span class="operator">=</span> PageHelper.startPage(pageNum, pageSize);</span><br><span class="line">            List&lt;Device&gt; devices = deviceService.getDevices();</span><br><span class="line"></span><br><span class="line">            pr = <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), devices);</span><br><span class="line">log.info(<span class="string">&quot;pageNum:&#123;&#125;,pageSize:&#123;&#125;&quot;</span>, pageNum, pageSize);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CommonException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS, pr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设备编号查询</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查找设备ByNo&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getDeviceByNo/&#123;no&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getDeviceByNo</span><span class="params">(<span class="meta">@PathVariable(&quot;no&quot;)</span> String no)</span> <span class="keyword">throws</span> CommonException &#123;</span><br><span class="line">        <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (redisTemplate.hasKey(<span class="string">&quot;devices:&quot;</span> + no)) &#123;</span><br><span class="line">log.info(<span class="string">&quot;重置时间-&gt;devices:&#123;&#125;&quot;</span>, no);</span><br><span class="line">                redisTemplate.expire(<span class="string">&quot;devices:&quot;</span> + no, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">log.info(<span class="string">&quot;从redis取出来的devices:&#123;&#125;&quot;</span>, no);</span><br><span class="line">                device = JSON.parseObject(String.valueOf(redisTemplate.opsForValue().get(<span class="string">&quot;devices:&quot;</span> + no)), Device.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;从mysql取出来的&#123;&#125;&quot;</span>, no);</span><br><span class="line">                <span class="comment">//mysql没有抛异常  下面捕获返回空</span></span><br><span class="line">                device = deviceService.getDeviceByNo(no);</span><br><span class="line">                <span class="comment">//取出来存入缓存</span></span><br><span class="line">                redisTemplate.opsForValue().set(<span class="string">&quot;devices:&quot;</span> + no, JSON.toJSONString(device), <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS, device);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CommonException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;头部查找&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/searchDevice&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">searchDevice</span><span class="params">(<span class="meta">@RequestBody</span> Device device)</span> &#123;</span><br><span class="line">        List&lt;Device&gt; devices;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            devices = deviceService.searchDevice(device);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS, devices);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CommonException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;更新设备&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateDevice&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">updateDevice</span><span class="params">(<span class="meta">@RequestBody</span> Device device)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceService.updateDevice(device) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//更新成功后判断是否有缓存  有就换</span></span><br><span class="line">            <span class="keyword">if</span> (redisTemplate.hasKey(<span class="string">&quot;devices:&quot;</span> + device.getDeviceNo())) &#123;</span><br><span class="line">                <span class="type">Boolean</span> <span class="variable">delete</span> <span class="operator">=</span> redisTemplate.delete(<span class="string">&quot;devices:&quot;</span> + device.getDeviceNo());</span><br><span class="line">                <span class="keyword">if</span> (delete) &#123;</span><br><span class="line">                    redisTemplate.opsForValue().set(<span class="string">&quot;devices:&quot;</span> + device.getDeviceNo(), JSON.toJSONString(device), <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;缓存更新失败，请检查！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(<span class="string">&quot;devices:&quot;</span> + device.getDeviceNo(), JSON.toJSONString(device), <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;删除设备&quot;)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/delete/&#123;no&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">deleteDeviceById</span><span class="params">(<span class="meta">@PathVariable(&quot;no&quot;)</span> String no)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceService.deleteDeviceByNo(no) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//删除成功后处理redis</span></span><br><span class="line">            <span class="keyword">if</span> (redisTemplate.delete(<span class="string">&quot;devices:&quot;</span> + no)) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;缓存删除成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//缓存删除失败  or  从select里面取的数据，没有进redis 直接删除也会打印log</span></span><br><span class="line">log.warn(<span class="string">&quot;缓存删除失败，请检查！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增设备&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/insert&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">insertDevice</span><span class="params">(<span class="meta">@RequestBody</span> Device device)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceService.insertDevice(device) == <span class="number">1</span>) &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;devices:&quot;</span> + device.getDeviceNo(), JSON.toJSONString(device), <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(ResultCode.ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/blog/">Previous</a></div><div class="pagination-next"><a href="/blog/page/3/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/blog/">1</a></li><li><a class="pagination-link is-current" href="/blog/page/2/">2</a></li><li><a class="pagination-link" href="/blog/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/my_img/avatar.png" alt="Quansui"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Quansui</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Sydney, Australia</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">29</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">27</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zjsygqs398" target="_blank" rel="noopener">Follow</a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/Internship/"><span class="level-start"><span class="level-item">Internship</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/Pytorch-Introduction/"><span class="level-start"><span class="level-item">Pytorch Introduction</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/USYD-Lecture/"><span class="level-start"><span class="level-item">USYD - Lecture</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-08T13:53:26.000Z">2024-08-08</time></p><p class="title"><a href="/blog/2024/08/08/Word2vec/">Word2vec</a></p><p class="categories"><a href="/blog/categories/NLP/">NLP</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-07T11:06:05.000Z">2024-08-07</time></p><p class="title"><a href="/blog/2024/08/07/XLNET/">XLNET</a></p><p class="categories"><a href="/blog/categories/NLP/">NLP</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-06T11:04:00.000Z">2024-08-06</time></p><p class="title"><a href="/blog/2024/08/06/tBERT/">tBERT</a></p><p class="categories"><a href="/blog/categories/NLP/">NLP</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-06T11:02:00.000Z">2024-08-06</time></p><p class="title"><a href="/blog/2024/08/06/UniLM/">UniLM</a></p><p class="categories"><a href="/blog/categories/NLP/">NLP</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-08-04T11:07:00.000Z">2024-08-04</time></p><p class="title"><a href="/blog/2024/08/04/RoBERTa%20&amp;%20BERT%20space%20bias/">RoBERTa &amp; BERT embedding space bias</a></p><p class="categories"><a href="/blog/categories/NLP/">NLP</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/archives/2024/"><span class="level-start"><span class="level-item">2024</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/blog/tags/BERT/"><span class="tag">BERT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Cache/"><span class="tag">Cache</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Data-Analyse/"><span class="tag">Data Analyse</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Deep-Learning/"><span class="tag">Deep Learning</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/GIT/"><span class="tag">GIT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/IT-Innovation/"><span class="tag">IT Innovation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/JPA/"><span class="tag">JPA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Java/"><span class="tag">Java</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Linear-Regression/"><span class="tag">Linear Regression</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/MQ/"><span class="tag">MQ</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Machine-Learning/"><span class="tag">Machine Learning</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/NLP/"><span class="tag">NLP</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Natural-Language-Processing/"><span class="tag">Natural Language Processing</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Python/"><span class="tag">Python</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Pytorch/"><span class="tag">Pytorch</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/R/"><span class="tag">R</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Schedule/"><span class="tag">Schedule</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Shiro/"><span class="tag">Shiro</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Social-Science/"><span class="tag">Social Science</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/SpaCy/"><span class="tag">SpaCy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Startups/"><span class="tag">Startups</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Swagger/"><span class="tag">Swagger</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Thread/"><span class="tag">Thread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Tools/"><span class="tag">Tools</span><span class="tag">2</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/"><img src="/blog/my_img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2024 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zjsygqs398"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>